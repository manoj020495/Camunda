public void handleUserTaskVariable(Connection connection,
Record<?> eventRecord,
VariableRecordValue variableRecord) throws SQLException {
long scopeKey = variableRecord.getScopeKey();
long processInstanceKey = variableRecord.getProcessInstanceKey();

// Only proceed if scopeKey exists in USER_TASK table (means it's a User Task variable)
String sqlCheck = "SELECT 1 FROM CAMUNDA_USER_TASK WHERE USER_TASK_KEY = ?";
try (PreparedStatement checkStmt = connection.prepareStatement(sqlCheck)) {
checkStmt.setLong(1, scopeKey);
try (ResultSet rs = checkStmt.executeQuery()) {
if (!rs.next()) {
log.debug("Skipping variable {} because scopeKey {} does not belong to a user task",
variableRecord.getName(), scopeKey);
return;
}
}
}

// Now safe to insert/update into USER_TASK_VARIABLE
String sql = "MERGE INTO CAMUNDA_USER_TASK_VARIABLE t " +
"USING (SELECT ? AS NAME, ? AS SCOPE_KEY, ? AS PROCESS_INSTANCE_KEY FROM dual) s " +
"ON (t.NAME = s.NAME AND t.SCOPE_KEY = s.SCOPE_KEY AND t.PROCESS_INSTANCE_KEY = s.PROCESS_INSTANCE_KEY) " +
"WHEN MATCHED THEN " +
" UPDATE SET VALUE = ?, UPDATED_TSTAMP = ?, UPDATED_BY = ? " +
"WHEN NOT MATCHED THEN " +
" INSERT (NAME, VALUE, SCOPE_KEY, PROCESS_INSTANCE_KEY, PROCESS_DEFINITION_KEY, " +
" BPMN_PROCESS_ID, TENANT_ID, CREATED_TSTAMP, UPDATED_TSTAMP, CREATED_BY, UPDATED_BY) " +
" VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

try (PreparedStatement stmt = connection.prepareStatement(sql)) {
OffsetDateTime now = OffsetDateTime.now(ZoneOffset.UTC);
String systemUser = "SYSTEM";

// USING clause
stmt.setString(1, variableRecord.getName());
stmt.setLong(2, scopeKey);
stmt.setLong(3, processInstanceKey);

// UPDATE SET
stmt.setString(4, variableRecord.getValue().toString());
stmt.setObject(5, now);
stmt.setString(6, systemUser);

// INSERT values
stmt.setString(7, variableRecord.getName());
stmt.setString(8, variableRecord.getValue().toString());
stmt.setLong(9, scopeKey);
stmt.setLong(10, processInstanceKey);
stmt.setLong(11, variableRecord.getProcessDefinitionKey());
stmt.setString(12, variableRecord.getBpmnProcessId());
stmt.setString(13, variableRecord.getTenantId());
stmt.setObject(14, now);
stmt.setObject(15, now);
stmt.setString(16, systemUser);
stmt.setString(17, systemUser);

int rows = stmt.executeUpdate();
log.info("UserTaskVariableHandler: Upserted variable {} for scopeKey {} (rows={})",
variableRecord.getName(), scopeKey, rows);
}
}
